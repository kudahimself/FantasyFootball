{% extends "base.html" %}
{% load static %}

{% block title %}Team Selection{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/squads.css' %}">

<style>
    /* Team Selection page: make formation span full screen width */
    .container-fluid { padding-left: 0 !important; padding-right: 0 !important; }
    #current-squad { padding: 0 !important; margin: 0 !important; }
    #squad-content { padding: 0 !important; margin: 0 !important; }
    #formation {
        padding: 0 !important;       /* remove inner padding so rows use full width */
        margin: 0 auto 20px !important;
        max-width: none !important;  /* drop 1400px cap on this page */
        width: 100% !important;      /* occupy full available width */
    }
    /* Optional: tighten top/bottom spacing for maximum vertical space */
    h1, h2 { margin-left: 10px; }

    /* Sub-navigation styles (match squads page) */
    .squad-nav .btn { margin-right: 8px; }
    .squad-nav .btn:last-child { margin-right: 0; }
    .squad-nav { padding: 8px 12px; border-bottom: 1px solid #dee2e6; margin-bottom: 1rem; }
    @media (max-width: 576px) {
        .squad-nav .btn { margin-bottom: 6px; }
    }
</style>




<!-- Add Player Form -->
<div id="add-player-form" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 5px;">
    <h3>Add Player</h3>
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <select id="player-position" onchange="updatePlayerSearch()">
            <option value="">All Positions</option>
            <option value="goalkeepers">Goalkeeper</option>
            <option value="defenders">Defender</option>
            <option value="midfielders">Midfielder</option>
            <option value="forwards">Forward</option>
        </select>
        
        <!-- Smart Player Search with Autocomplete -->
        <div style="position: relative; min-width: 300px;">
            <input type="text" 
                   id="player-search-input" 
                   placeholder="Start typing player name..." 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px;"
                   onkeyup="searchPlayers(this.value)"
                   onfocus="showSearchResults()"
                   autocomplete="off">
            
            <!-- Search Results Dropdown -->
            <div id="player-search-results" 
                 style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 3px 3px; max-height: 250px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <!-- Search results will appear here -->
            </div>
        </div>
        
        <button onclick="addSelectedPlayerToSquad()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 3px;">Add Player</button>
        <button onclick="loadAllPlayers()" style="padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 3px;">Refresh Players</button>
        <button id="btn-refresh-squad" onclick="loadCurrentSquad()" style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 3px;">Refresh Squad</button>
    </div>
    <div id="player-info" style="margin-top: 10px; font-size: 14px; color: #666;">
        <!-- Player info will be displayed here -->
    </div>
</div>

<!-- Squad Display -->
<div id="current-squad">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Team Selection</h2>
        <div class="d-flex" style="gap: 12px;">
            <div class="badge bg-primary p-2" style="font-size: 0.9em;">
                <i class="fas fa-chart-line"></i> Team Elo: <span id="team-elo">--</span>
            </div>
            <div class="badge bg-info p-2" style="font-size: 0.9em;">
                <i class="fas fa-star"></i> Projected Points: <span id="team-projected">--</span>
            </div>
            <div class="badge bg-success p-2" style="font-size: 0.9em;">
                <i class="fas fa-pound-sign"></i> Total Cost: £<span id="team-cost">--</span>m
            </div>
            <button class="btn btn-sm btn-info" onclick="directCalculation()" title="Refresh totals">
                <i class="fas fa-calculator"></i>
            </button>
        </div>
    </div>
    <div id="squad-content">
        <!-- Squad content will be loaded here -->
    </div>
</div>

<!-- Substitute Recommendations Section -->
<div id="substitute-recommendations" style="margin: 30px 0; padding: 20px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 style="margin: 0; color: #495057;">
            <i class="fas fa-exchange-alt text-primary"></i> Recommended Substitutes
        </h3>
        <div>
            <button class="btn btn-sm btn-outline-primary" onclick="loadSubstituteRecommendations()" title="Get recommendations">
                <i class="fas fa-sync-alt"></i> Get Recommendations
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="toggleRecommendationsSection()" title="Toggle section">
                <i class="fas fa-eye" id="toggle-recommendations-icon"></i>
            </button>
        </div>
    </div>
    
    <div id="recommendations-content">
        <div id="recommendations-loading" class="text-center py-4" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2 text-muted">Analyzing your squad and finding the best substitutes...</p>
        </div>
        
        <div id="recommendations-empty" class="text-center py-4">
            <i class="fas fa-lightbulb fa-2x text-muted"></i>
            <p class="mt-2 text-muted">Click "Get Recommendations" to see suggested improvements for your squad</p>
        </div>
        
        <div id="recommendations-list" style="display: none;">
            <div id="recommendations-summary" class="mb-4 p-3 bg-light rounded">
                <!-- Summary will be populated here -->
            </div>
            
            <div class="row" id="recommendations-cards">
                <!-- Recommendation cards will be populated here -->
            </div>
        </div>
        
        <div id="recommendations-error" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-message"></span>
        </div>
    </div>
</div>

<!-- Status Messages -->
<div id="status-message" style="margin: 20px 0; padding: 10px; border-radius: 3px; display: none;"></div>

<script src="{% static 'js/team_selection.js' %}"></script>

<script>
// Direct calculation function as backup
function directCalculation() {
    console.log('Running direct calculation...');
    
    fetch('/api/current_squad/')
        .then(response => response.json())
        .then(data => {
            const squad = data.current_squad;
            let totalElo = 0, totalCost = 0, totalProjectedPoints = 0, playerCount = 0;
            const playerNames = [];
            
            ['goalkeepers', 'defenders', 'midfielders', 'forwards'].forEach(position => {
                if (squad[position]) {
                    squad[position].forEach(player => {
                        if (player && player.elo !== undefined && player.cost !== undefined) {
                            totalElo += parseFloat(player.elo);
                            totalCost += parseFloat(player.cost);
                            playerCount++;
                            playerNames.push(player.name);
                        }
                    });
                }
            });
            
            const avgElo = playerCount > 0 ? totalElo / playerCount : 0;
            
            // Update ELO and Cost immediately
            document.getElementById('team-elo').textContent = playerCount > 0 ? avgElo.toFixed(1) : '--';
            document.getElementById('team-cost').textContent = playerCount > 0 ? totalCost.toFixed(1) : '--';
            
            // Fetch projected points for all players
            if (playerNames.length > 0) {
                const projectedPointsPromises = playerNames.map(playerName => 
                    fetch(`/api/all_projected_points/?player_name=${encodeURIComponent(playerName)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.total_projected_points) {
                                return parseFloat(data.total_projected_points);
                            }
                            return 0;
                        })
                        .catch(error => {
                            console.error(`Error fetching projected points for ${playerName}:`, error);
                            return 0;
                        })
                );
                
                Promise.all(projectedPointsPromises)
                    .then(projectedPointsArray => {
                        totalProjectedPoints = projectedPointsArray.reduce((sum, points) => sum + points, 0);
                        document.getElementById('team-projected').textContent = totalProjectedPoints.toFixed(1);
                        
                        console.log(`Direct calc: ${playerCount} players, Avg Elo: ${avgElo.toFixed(1)}, Total Cost: £${totalCost.toFixed(1)}m, Projected Points: ${totalProjectedPoints.toFixed(1)}`);
                    })
                    .catch(error => {
                        console.error('Error calculating projected points:', error);
                        document.getElementById('team-projected').textContent = '--';
                    });
            } else {
                document.getElementById('team-projected').textContent = '--';
            }
        })
        .catch(error => console.error('Direct calc error:', error));
}

// Run direct calculation after page loads
setTimeout(directCalculation, 1000);
</script>

{% endblock %}