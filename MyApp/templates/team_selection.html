{% extends "base.html" %}
{% load static %}

{% block title %}Team Selection{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/squad_content.css' %}">
<link rel="stylesheet" href="{% static 'css/team_selection.css' %}">

<!-- Main Team Selection Container -->
<div class="team-selection-container">
    <!-- Player Selection Pane -->
    <div class="player-selection-pane">
        <div class="player-selection-header">
            <h4 class="mb-2">Player Selection</h4>
        </div>
        
        <!-- Search Section -->
        <div class="player-search-section">
            <label class="form-label mb-2" style="font-weight: 600; font-size: 0.9em;">Find a player</label>
            <div style="position: relative;">
                <input type="text" class="search-input" id="player-search" placeholder="Search by name">
            </div>
        </div>
        
        <!-- Filters Section -->
        <div class="player-filters">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span style="font-weight: 600; font-size: 0.9em;">All players</span>
                <button class="btn btn-sm btn-outline-secondary" id="reset-filters-btn">Reset</button>
            </div>
            <div class="position-tabs">
                <div class="position-tab active" data-position="all">All</div>
                <div class="position-tab" data-position="GKP">GKP</div>
                <div class="position-tab" data-position="DEF">DEF</div>
                <div class="position-tab" data-position="MID">MID</div>
                <div class="position-tab" data-position="FWD">FWD</div>
            </div>
            <div class="player-counter" id="player-counter">
                7 top players shown
            </div>
        </div>
        
        <!-- Players List -->
        <div class="players-list" id="players-list">
            {% if error %}
                <div class="alert alert-danger m-3">{{ error }}</div>
            {% elif players %}
                {% for player in players %}
                    <div class="player-card" 
                         data-name="{{ player.name|lower }}"
                         data-team="{{ player.team|lower }}"
                         data-position="{{ player.position }}">
                        <div class="player-info">
                            <div class="player-name">
                                {{ player.name }} 
                                <span class="badge 
                                    {% if player.position == 'GKP' %}bg-warning text-dark{% endif %}
                                    {% if player.position == 'DEF' %}bg-primary{% endif %}
                                    {% if player.position == 'MID' %}bg-success{% endif %}
                                    {% if player.position == 'FWD' %}bg-danger{% endif %}
                                    ms-2">{{ player.position }}</span>
                            </div>
                            <div class="player-team">üìç {{ player.team }}</div>
                        </div>
                        <div class="player-stats">
                            <div class="player-price">¬£{{ player.cost }}m</div>
                            <div class="player-points">üìä {{ player.elo }}</div>
                            <div class="player-projected">‚≠ê {{ player.projected_points }}pts</div>
                        </div>
                        <button class="add-btn" onclick="addPlayer('{{ player.id }}', '{{ player.name|escapejs }}')">+ Add</button>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info m-3">No players found.</div>
            {% endif %}
        </div>
    </div>
    
    <!-- Team Formation Pane -->
    <div class="team-formation-pane">
        <!-- Squad Display -->
        <div id="current-squad">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 id="team-selection-header">Fantasy 11</h2>
                <div class="d-flex" style="gap: 12px;">
                    <div class="badge bg-primary p-2" style="font-size: 0.9em;">
                        <i class="fas fa-chart-line"></i> Avg. ELO: <span id="squad-avg-elo">--</span>
                    </div>
                    <div class="badge bg-info p-2" style="font-size: 0.9em;">
                        <i class="fas fa-star"></i> Projected Total Points: <span id="squad-projected-points">--</span>
                    </div>
                    <div class="badge bg-success p-2" style="font-size: 0.9em;">
                        <i class="fas fa-pound-sign"></i> Total Cost: ¬£<span id="squad-total-cost">--</span>m
                    </div>
                </div>
            </div>
            <div id="squad-content">
                <div id="squad-list" class="squad-list"></div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <button id="make-changes-btn" class="btn btn-secondary ms-2" onclick="toggleEditMode()">
                    <i class="edit-mode-icon fas fa-edit"></i> Make Changes
                </button>
                <div class="d-flex" style="gap: 10px;">
                    <button id="apply-changes-btn" class="btn btn-success" onclick="applyChangesToBackend()">
                        <i class="fas fa-save"></i> Apply Changes
                    </button>
                    <button id="discard-changes-btn" class="btn btn-secondary ms-2" onclick="discardLocalChanges()">
                        <i class="fas fa-undo"></i> Discard Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Substitute Recommendations Section -->
<div id="substitute-recommendations" style="margin: 30px 0; padding: 20px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 style="margin: 0; color: #495057;">
            <i class="fas fa-exchange-alt text-primary"></i> Recommended Substitutes
        </h3>
        <div>
            <button class="btn btn-sm btn-outline-primary" onclick="loadSubstituteRecommendations()" title="Get recommendations">
                <i class="fas fa-sync-alt"></i> Get Recommendations
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="toggleRecommendationsSection()" title="Toggle section">
                <i class="fas fa-eye" id="toggle-recommendations-icon"></i>
            </button>
        </div>
    </div>
    
    <div id="recommendations-content">
        <div id="recommendations-loading" class="text-center py-4" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2 text-muted">Analyzing your squad and finding the best substitutes...</p>
        </div>
        
        <div id="recommendations-empty" class="text-center py-4">
            <i class="fas fa-lightbulb fa-2x text-muted"></i>
            <p class="mt-2 text-muted">Click "Get Recommendations" to see suggested improvements for your squad</p>
        </div>
        
        <div id="recommendations-list" style="display: none;">
            <div id="recommendations-summary" class="mb-4 p-3 bg-light rounded">
                <!-- Summary will be populated here -->
            </div>
            
            <div class="row" id="recommendations-cards">
                <!-- Recommendation cards will be populated here -->
            </div>
        </div>
        
        <div id="recommendations-error" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-message"></span>
        </div>
    </div>
</div>

<!-- Status Messages -->
<div id="status-message" style="margin: 20px 0; padding: 10px; border-radius: 3px; display: none;"></div>


<script>
// Team management variables (make them global)
window.localTeam = [];
window.dynamicAllPlayers = [];
window.editMode = false;
window.currentSquadData = JSON.parse('{{ current_squad_json|escapejs }}');
// Pass Django template data to JavaScript (make it global)
window.serverPlayers = JSON.parse('{{ players_json|escapejs }}');
console.log('üîÑ Server players data:', window.serverPlayers);

// Global variables for dynamic system
let dynamicAllPlayers = [];
let dynamicFilteredPlayers = [];
let currentSquad = {};
let allPlayers = {};
let allPlayersFlat = []; // Flat array for search
let recommendationsVisible = true;
let currentRecommendationPackage = [];

</script>

<script src="{% static 'js/team_selection.js' %}"></script>
<script src="{% static 'js/team_selection_updates.js' %}"></script>
<script src="{% static 'js/team_selection_rendering.js' %}"></script>
<script src="{% static 'js/team_selection_global_functions.js' %}"></script>
<script src="{% static 'js/recommendations.js' %}"></script>

{% endblock %}