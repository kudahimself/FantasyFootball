{% extends "base.html" %}
{% load static %}

{% block title %}Team Selection{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/squads.css' %}">
<link rel="stylesheet" href="{% static 'css/team_selection.css' %}">

<!-- Main Team Selection Container -->
<div class="team-selection-container">
    <!-- Player Selection Pane -->
    <div class="player-selection-pane">
        <div class="player-selection-header">
            <h4 class="mb-2">Player Selection</h4>
        </div>
        
        <!-- Search Section -->
        <div class="player-search-section">
            <label class="form-label mb-2" style="font-weight: 600; font-size: 0.9em;">Find a player</label>
            <div style="position: relative;">
                <input type="text" class="search-input" id="player-search" placeholder="Search by name">
                <!-- Search Results Dropdown -->
                <div id="player-search-dropdown" 
                     class="position-absolute w-100 shadow-sm bg-white border"
                     style="top: 100%; z-index: 1000; display: none; max-height: 300px; overflow-y: auto; border-radius: 0 0 8px 8px;">
                    <!-- Search suggestions will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Filters Section -->
        <div class="player-filters">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span style="font-weight: 600; font-size: 0.9em;">All players</span>
                <button class="btn btn-sm btn-outline-secondary" id="reset-filters-btn">Reset</button>
            </div>
            <div class="position-tabs">
                <div class="position-tab active" data-position="all">All</div>
                <div class="position-tab" data-position="GKP">GKP</div>
                <div class="position-tab" data-position="DEF">DEF</div>
                <div class="position-tab" data-position="MID">MID</div>
                <div class="position-tab" data-position="FWD">FWD</div>
            </div>
            <div class="player-counter" id="player-counter">
                7 top players shown
            </div>
        </div>
        
        <!-- Players List -->
        <div class="players-list" id="players-list">
            {% if error %}
                <div class="alert alert-danger m-3">{{ error }}</div>
            {% elif players %}
                {% for player in players %}
                    <div class="player-card" 
                         data-name="{{ player.name|lower }}"
                         data-team="{{ player.team|lower }}"
                         data-position="{{ player.position }}">
                        <div class="player-info">
                            <div class="player-name">
                                {{ player.name }} 
                                <span class="badge 
                                    {% if player.position == 'GKP' %}bg-warning text-dark{% endif %}
                                    {% if player.position == 'DEF' %}bg-primary{% endif %}
                                    {% if player.position == 'MID' %}bg-success{% endif %}
                                    {% if player.position == 'FWD' %}bg-danger{% endif %}
                                    ms-2">{{ player.position }}</span>
                            </div>
                            <div class="player-team">üìç {{ player.team }}</div>
                        </div>
                        <div class="player-stats">
                            <div class="player-price">¬£{{ player.cost }}m</div>
                            <div class="player-points">üìä {{ player.elo_rating }}</div>
                            <div class="player-projected">‚≠ê {{ player.projected_points }}pts</div>
                        </div>
                        <button class="add-btn" onclick="addPlayer('{{ player.id }}', '{{ player.name|escapejs }}')">+ Add</button>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info m-3">No players found.</div>
            {% endif %}
        </div>
    </div>
    
    <!-- Team Formation Pane -->
    <div class="team-formation-pane">
        <!-- Squad Display -->
        <div id="current-squad">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Team Selection</h2>
                <div class="d-flex" style="gap: 12px;">
                    <div class="badge bg-primary p-2" style="font-size: 0.9em;">
                        <i class="fas fa-chart-line"></i> Avg. ELO: <span id="squad-avg-elo">--</span>
                    </div>
                    <div class="badge bg-info p-2" style="font-size: 0.9em;">
                        <i class="fas fa-star"></i> Projected Total Points: <span id="squad-projected-points">--</span>
                    </div>
                    <div class="badge bg-success p-2" style="font-size: 0.9em;">
                        <i class="fas fa-pound-sign"></i> Total Cost: ¬£<span id="squad-total-cost">--</span>m
                    </div>
                </div>
            </div>
            <div id="squad-content">
                <!-- Squad content will be loaded here -->
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button id="apply-changes-btn" class="btn btn-success" onclick="applyChangesToBackend()">
                    <i class="fas fa-save"></i> Apply Changes
                </button>
                <button id="discard-changes-btn" class="btn btn-secondary ms-2" onclick="discardLocalChanges()">
                    <i class="fas fa-undo"></i> Discard Changes
                </button>
            </div>
    <!-- All custom JS helpers and logic for localTeam and Apply Changes must be inside a script block -->
    <script>
    // Store the last loaded backend squad for diffing
    window.lastBackendSquad = [];

    // Helper: get a flat array of player IDs from a team array
    function getPlayerIds(teamArr) {
        return (teamArr || []).map(p => p.id).sort();
    }

    // Helper: deep copy a team array
    function copyTeam(teamArr) {
        return (teamArr || []).map(p => ({...p}));
    }

    // Patch loadCurrentSquadFromDatabase to also store lastBackendSquad
    const origLoadCurrentSquadFromDatabase = loadCurrentSquadFromDatabase;
    loadCurrentSquadFromDatabase = function() {
        try {
            const currentSquadData = JSON.parse('{{ current_squad_json|escapejs }}');
            window.localTeam = [];
            let playerData = window.serverPlayers;
            if (!playerData) {
                try {
                    playerData = JSON.parse('{{ players_json|escapejs }}');
                    window.serverPlayers = playerData;
                } catch (e) { return; }
            }
            const positionMapping = {
                'goalkeepers': 'GKP',
                'defenders': 'DEF',
                'midfielders': 'MID',
                'forwards': 'FWD'
            };
            let backendSquad = [];
            Object.keys(positionMapping).forEach(dbPosition => {
                const players = currentSquadData[dbPosition] || [];
                players.forEach(playerEntry => {
                    let playerName = typeof playerEntry === 'string' ? playerEntry : playerEntry.name;
                    if (!playerName) return;
                    const playerMatch = playerData.find(p => p.name === playerName);
                    if (playerMatch) {
                        const expectedPosition = positionMapping[dbPosition];
                        const playerObj = playerMatch.position === expectedPosition ? playerMatch : { ...playerMatch, position: expectedPosition };
                        window.localTeam.push(playerObj);
                        backendSquad.push(playerObj);
                    }
                });
            });
            window.lastBackendSquad = copyTeam(backendSquad);
            updateSquadBadges();
            updateSquadDisplay();
        } catch (e) {
            window.localTeam = [];
            window.lastBackendSquad = [];
            updateSquadBadges();
            updateSquadDisplay();
        }
    }

    // Apply Changes button logic
    function applyChangesToBackend() {
        // Save the entire localTeam as the new current squad, grouped by position with full player objects
        if (!window.localTeam || window.localTeam.length === 0) {
            alert('No players in your squad to save!');
            return;
        }
        // Send the flat localTeam array; backend will group it
        const squadToSend = window.localTeam.map(player => {
            const playerObj = {};
            ['id','name','position','team','cost','elo','elo_rating','projected_points'].forEach(k => {
                if (player[k] !== undefined) playerObj[k] = player[k];
            });
            if (playerObj.elo_rating && !playerObj.elo) playerObj.elo = playerObj.elo_rating;
            return playerObj;
        });
        const btn = document.getElementById('apply-changes-btn');
        if (btn) btn.disabled = true;
        fetch('/api/update_current_squad/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ squad: squadToSend })
        })
        .then(response => response.json())
        .then(data => {
            if (btn) btn.disabled = false;
            if (data.success) {
                // Refresh the page after successful save
                location.reload();
            } else {
                // Optionally show a non-intrusive error message
                showStatusMessage('Error saving squad: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            if (btn) btn.disabled = false;
            showStatusMessage('Error saving squad: ' + (error.message || error), 'error');
        });
    }

    // Patch updateDatabaseSquad to support callbacks
    const origUpdateDatabaseSquad = updateDatabaseSquad;
    updateDatabaseSquad = function(player, action, onSuccess, onError) {
        const positionMapping = {
            'GKP': 'goalkeepers',
            'DEF': 'defenders',
            'MID': 'midfielders',
            'FWD': 'forwards'
        };
        const dbPosition = positionMapping[player.position];
        if (!dbPosition) {
            if (onError) onError('Unknown position for database update: ' + player.position);
            return;
        }
        const url = action === 'add' ? '/add_player/' : '/remove_player/';
        const data = {
            position: dbPosition,
            player_name: player.name
        };
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (onSuccess) onSuccess();
            } else {
                if (onError) onError(data.error || 'Unknown error');
            }
        })
        .catch(error => {
            if (onError) onError(error.message || error);
        });
    }
    </script>
        </div>
    </div>
</div>

<!-- Substitute Recommendations Section -->
<div id="substitute-recommendations" style="margin: 30px 0; padding: 20px; background: #fff; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 style="margin: 0; color: #495057;">
            <i class="fas fa-exchange-alt text-primary"></i> Recommended Substitutes
        </h3>
        <div>
            <button class="btn btn-sm btn-outline-primary" onclick="loadSubstituteRecommendations()" title="Get recommendations">
                <i class="fas fa-sync-alt"></i> Get Recommendations
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="toggleRecommendationsSection()" title="Toggle section">
                <i class="fas fa-eye" id="toggle-recommendations-icon"></i>
            </button>
        </div>
    </div>
    
    <div id="recommendations-content">
        <div id="recommendations-loading" class="text-center py-4" style="display: none;">
            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
            <p class="mt-2 text-muted">Analyzing your squad and finding the best substitutes...</p>
        </div>
        
        <div id="recommendations-empty" class="text-center py-4">
            <i class="fas fa-lightbulb fa-2x text-muted"></i>
            <p class="mt-2 text-muted">Click "Get Recommendations" to see suggested improvements for your squad</p>
        </div>
        
        <div id="recommendations-list" style="display: none;">
            <div id="recommendations-summary" class="mb-4 p-3 bg-light rounded">
                <!-- Summary will be populated here -->
            </div>
            
            <div class="row" id="recommendations-cards">
                <!-- Recommendation cards will be populated here -->
            </div>
        </div>
        
        <div id="recommendations-error" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-message"></span>
        </div>
    </div>
</div>

<!-- Status Messages -->
<div id="status-message" style="margin: 20px 0; padding: 10px; border-radius: 3px; display: none;"></div>

<script src="{% static 'js/team_selection.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('player-search');
        const positionTabs = document.querySelectorAll('.position-tab');
        const playerCards = document.querySelectorAll('.player-card');
        const playerCounter = document.getElementById('player-counter');
        const resetBtn = document.getElementById('reset-filters-btn');

        let currentPositionFilter = 'all';

        function filterAndRender() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            let visibleCount = 0;

            playerCards.forEach(card => {
                const name = card.dataset.name || '';
                const team = card.dataset.team || '';
                const playerPosition = card.getAttribute('data-position') || ''; // More direct attribute access

                const matchesSearch = searchTerm === '' || name.includes(searchTerm) || team.includes(searchTerm);
                const matchesPosition = currentPositionFilter === 'all' || playerPosition === currentPositionFilter;

                if (matchesSearch && matchesPosition) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            playerCounter.textContent = `${visibleCount} of {{ total_players }} players shown`;
        }

        searchInput.addEventListener('input', filterAndRender);

        positionTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                positionTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentPositionFilter = this.dataset.position;
                filterAndRender();
            });
        });

        resetBtn.addEventListener('click', function() {
            searchInput.value = '';
            positionTabs.forEach(t => t.classList.remove('active'));
            document.querySelector('.position-tab[data-position="all"]').classList.add('active');
            currentPositionFilter = 'all';
            filterAndRender();
        });
        
    // Team management variables (make them global)
    window.localTeam = [];
    window.dynamicAllPlayers = [];
        
        // Load player data for team management
        if (typeof window.serverPlayers === 'undefined' && document.querySelector('script')) {
            // Try to get server data from the second script block
            const scripts = document.querySelectorAll('script');
            for (let script of scripts) {
                if (script.textContent && script.textContent.includes('serverPlayers')) {
                    // Data will be loaded by the second script
                    break;
                }
            }
        }
    });
    
    // Global team management functions (outside DOMContentLoaded so they're immediately available)

    // Update squad display function (uses localTeam)
    function updateSquadDisplay() {
        const squadContent = document.getElementById('squad-content');
        if (!squadContent) return;
        const team = window.localTeam || [];
        // Group players by position
        const positionOrder = ['GKP', 'DEF', 'MID', 'FWD'];
        const positionBadges = {
            GKP: '<span class="badge bg-warning text-dark ms-2">GKP</span>',
            DEF: '<span class="badge bg-primary ms-2">DEF</span>',
            MID: '<span class="badge bg-success ms-2">MID</span>',
            FWD: '<span class="badge bg-danger ms-2">FWD</span>'
        };
        const grouped = { GKP: [], DEF: [], MID: [], FWD: [] };
        team.forEach(player => {
            if (grouped[player.position]) {
                grouped[player.position].push(player);
            }
        });
        let squadHTML = `<div class="squad-formation">`;
        squadHTML += `<div class="text-center mb-3"><small class="text-muted">${team.length}/11 players selected</small></div>`;
        if (team.length === 0) {
            squadHTML += `<div class="text-center py-4"><i class="fas fa-users fa-3x text-muted mb-3"></i><p class="text-muted">No players selected yet. Click "+ Add" on any player to start building your team.</p></div>`;
        } else {
            positionOrder.forEach(pos => {
                if (grouped[pos].length > 0) {
                    squadHTML += `<div class="position-group mb-2">`;
                    squadHTML += `<div class="position-label mb-1">${pos}</div>`;
                    grouped[pos].forEach(player => {
                        squadHTML += `<div class="selected-player-card">`;
                        squadHTML += `<div class="player-info">`;
                        squadHTML += `<div class="player-name">${player.name} ${positionBadges[player.position] || ''}</div>`;
                        squadHTML += `<div class="player-team">üìç ${player.team}</div>`;
                        squadHTML += `</div>`;
                        squadHTML += `<div class="player-stats">`;
                        squadHTML += `<div class="player-price">¬£${player.cost}m</div>`;
                        squadHTML += `<div class="player-points">üìä ${player.elo_rating ? Math.round(player.elo_rating * 10) / 10 : 0}</div>`;
                        squadHTML += `<div class="player-projected">‚≠ê ${player.projected_points || 0}pts</div>`;
                        squadHTML += `</div>`;
                        squadHTML += `<button class="btn btn-sm btn-outline-danger" onclick="removePlayer('${player.id}', '${player.name}')" title="Remove player"><i class="fas fa-times"></i></button>`;
                        squadHTML += `</div>`;
                    });
                    squadHTML += `</div>`;
                }
            });
        }
        squadHTML += `</div>`;
        squadContent.innerHTML = squadHTML;
    }

    // Remove player function (local only)
    function removePlayer(playerId, playerName) {
        if (!window.localTeam) return;
        const index = window.localTeam.findIndex(p => p.id == playerId || p.name === playerName);
        if (index > -1) {
            window.localTeam.splice(index, 1);
            updateSquadBadges();
            updateSquadDisplay();
            console.log(`üóëÔ∏è Removed ${playerName} from local team. Team size: ${window.localTeam.length}`);
        }
    }
    
    // Update database squad function
    function updateDatabaseSquad(player, action) {
        // Map our position format to database position format
        const positionMapping = {
            'GKP': 'goalkeepers',
            'DEF': 'defenders',
            'MID': 'midfielders', 
            'FWD': 'forwards'
        };
        
        const dbPosition = positionMapping[player.position];
        if (!dbPosition) {
            console.error('‚ùå Unknown position for database update:', player.position);
            return;
        }
        
        const url = action === 'add' ? '/add_player/' : '/remove_player/';
        const data = {
            position: dbPosition,
            player_name: player.name
        };
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`‚úÖ Database updated: ${action} ${player.name}`);
            } else {
                console.error(`‚ùå Database update failed: ${data.error}`);
            }
        })
        .catch(error => {
            console.error(`‚ùå Error updating database:`, error);
        });
    }

 
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentSquadFromDatabase();
        setTimeout(updateSquadDisplay, 0);
    });
    
    // Load current squad from database (loads into localTeam)
    function loadCurrentSquadFromDatabase() {
        try {
            const currentSquadData = JSON.parse('{{ current_squad_json|escapejs }}');
            console.log('üìä Loading current squad from database:', currentSquadData);
            window.localTeam = [];
            let playerData = window.serverPlayers;
            if (!playerData) {
                try {
                    playerData = JSON.parse('{{ players_json|escapejs }}');
                    window.serverPlayers = playerData;
                } catch (e) {
                    console.error('Failed to load player data for squad conversion:', e);
                    return;
                }
            }
            const positionMapping = {
                'goalkeepers': 'GKP',
                'defenders': 'DEF',
                'midfielders': 'MID',
                'forwards': 'FWD'
            };
            Object.keys(positionMapping).forEach(dbPosition => {
                const players = currentSquadData[dbPosition] || [];
                players.forEach(playerEntry => {
                    let playerName = typeof playerEntry === 'string' ? playerEntry : playerEntry.name;
                    if (!playerName) return;
                    const playerMatch = playerData.find(p => p.name === playerName);
                    if (playerMatch) {
                        const expectedPosition = positionMapping[dbPosition];
                        if (playerMatch.position === expectedPosition) {
                            window.localTeam.push(playerMatch);
                        } else {
                            const correctedPlayer = { ...playerMatch, position: expectedPosition };
                            window.localTeam.push(correctedPlayer);
                        }
                        console.log(`‚úÖ Added ${playerName} (${expectedPosition}) to local team`);
                    } else {
                        console.warn(`‚ö†Ô∏è Player ${playerName} not found in available players data, skipping.`);
                    }
                });
            });
            // Remove any undefined/null entries just in case
            window.localTeam = window.localTeam.filter(Boolean);
            console.log(`üìä Loaded ${window.localTeam.length} players from current squad`);
            updateSquadBadges();
            updateSquadDisplay();
        } catch (e) {
            console.error('‚ùå Error loading current squad:', e);
            window.localTeam = [];
            updateSquadBadges();
            updateSquadDisplay();
        }
    }

    // Update squad badges using only the local team
    function updateSquadBadges() {
        const squad = window.localTeam || [];
        const avgEloElem = document.getElementById('squad-avg-elo');
        const projElem = document.getElementById('squad-projected-points');
        const costElem = document.getElementById('squad-total-cost');
        if (!avgEloElem || !projElem || !costElem) return;
        if (!squad.length) {
            avgEloElem.textContent = '--';
            projElem.textContent = '--';
            costElem.textContent = '--';
            console.log('updateSquadBadges: squad empty');
            return;
        }
        const totalElo = squad.reduce((sum, p) => sum + (p.elo_rating || 0), 0);
        const avgElo = totalElo / squad.length;
        const projectedPoints = squad.reduce((sum, p) => sum + (p.projected_points || 0), 0);
        const totalCost = squad.reduce((sum, p) => sum + (p.cost || 0), 0);
        avgEloElem.textContent = avgElo ? Math.round(avgElo * 10) / 10 : '--';
        projElem.textContent = projectedPoints ? Math.round(projectedPoints * 10) / 10 : '--';
        costElem.textContent = totalCost ? Math.round(totalCost * 10) / 10 : '--';
        console.log('updateSquadBadges:', { squad, avgElo, projectedPoints, totalCost });
    }
</script>

<script>
// Pass Django template data to JavaScript (make it global)
window.serverPlayers = JSON.parse('{{ players_json|escapejs }}');
console.log('üîÑ Server players data:', window.serverPlayers);

// Global variables for dynamic system
let dynamicAllPlayers = [];
let dynamicFilteredPlayers = [];

// Initialize with server data
function initializeWithServerData() {
    try {
        console.log('üìä Initializing with server data...');
        
        if (typeof window.serverPlayers !== 'undefined' && Array.isArray(window.serverPlayers) && window.serverPlayers.length > 0) {
            // Use all players instead of slicing to 5
            dynamicAllPlayers = window.serverPlayers; 
            dynamicFilteredPlayers = [...dynamicAllPlayers];
            
            // Also update the global reference
            window.dynamicAllPlayers = dynamicAllPlayers;
            
            console.log(`‚úÖ Success! Loaded ${dynamicAllPlayers.length} players.`);
            
            // Render players and update counter
            renderPlayers();
            updatePlayerCounter();
            updateSquadBadges(); // Initialize squad badges

            // Hide the loading indicator that shows "Preparing player data..."
            const initialLoading = document.getElementById('initial-loading');
            if (initialLoading) {
                initialLoading.style.display = 'none';
            }
            
        } else {
            console.warn('‚ö†Ô∏è No player data found from server. `serverPlayers` is either undefined, not an array, or empty.');
            throw new Error('No valid player data was provided by the server.');
        }
        
    } catch (error) {
        console.error('‚ùå Critical Error: Could not initialize player data.', error);
        
        const playersList = document.getElementById('players-list');
        if (playersList) {
            playersList.innerHTML = `
                <div class="alert alert-danger m-3">
                    <h6><i class="fas fa-exclamation-triangle"></i> Failed to Load Players</h6>
                    <p class="mb-2">There was a JavaScript error while loading player data. Check the browser console for details.</p>
                    <p><em>${error.message}</em></p>
                    <button class="btn btn-sm btn-outline-danger" onclick="location.reload()">üîÑ Reload Page</button>
                </div>
            `;
        }
    }
}

// Render players dynamically
function renderPlayers() {
    const playersList = document.getElementById('players-list');
    
    if (dynamicFilteredPlayers.length === 0) {
        playersList.innerHTML = `
            <div class="alert alert-info m-3">
                <i class="fas fa-search"></i> No players found matching your criteria.
            </div>
        `;
        return;
    }
    
    const playersHTML = dynamicFilteredPlayers.map(player => {
        // Format player data safely
        const name = player.name || 'Unknown Player';
        const team = player.team || 'Unknown Team';
        const position = player.position || 'UNK';
        const eloRating = player.elo_rating ? Math.round(player.elo_rating * 10) / 10 : 0;
        const cost = player.cost ? `¬£${player.cost}m` : '¬£0.0m';
        const projectedPoints = player.projected_points || 0;
        
        // Position badge colors and display
        const positionMap = {
            'GKP': { display: 'GKP', class: 'bg-warning text-dark' },
            'DEF': { display: 'DEF', class: 'bg-primary' },
            'MID': { display: 'MID', class: 'bg-success' },
            'FWD': { display: 'FWD', class: 'bg-danger' }
        };
        
        const posMap = positionMap[position] || { display: position, class: 'bg-secondary' };
        
        return `
            <div class="player-card">
                <div class="player-info">
                    <div class="player-name">${name} <span class="badge ${posMap.class} ms-2">${posMap.display}</span></div>
                    <div class="player-team">üìç ${team}</div>
                </div>
                <div class="player-stats">
                    <div class="player-price">${cost}</div>
                    <div class="player-points">üìä ${eloRating}</div>
                    <div class="player-projected">‚≠ê ${projectedPoints}pts</div>
                </div>
                <button class="add-btn" onclick="addPlayer('${player.id || name}', '${name}')">+ Add</button>
            </div>
        `;
    }).join('');
    
    playersList.innerHTML = playersHTML;
}

// Add player function
function addPlayer(playerId, playerName) {
    console.log('‚ûï Adding player:', playerName, 'ID:', playerId);
    console.log('üìä dynamicAllPlayers array length:', dynamicAllPlayers.length);
    
    // Find the player in dynamicAllPlayers array
    const player = dynamicAllPlayers.find(p => p.id == playerId || p.name === playerName);
    
    if (!player) {
        console.error('‚ùå Player not found in dynamicAllPlayers array:', playerId, playerName);
        alert('Player not found!');
        return;
    }
    
    console.log('‚úÖ Found player:', player);
    
    // Check if player is already selected
    if (window.localTeam.find(p => p.id === player.id)) {
        // alert(`${playerName} is already in your team!`);
        showStatusMessage(`${playerName} is already in your team!`, 'error');
        return;
    }
    
    // Check team size limit (11 players)
    if (window.localTeam.length >= 11) {
        // alert('Your team is full! (11 players maximum)');
        showStatusMessage('Your team is full! (11 players maximum)', 'error');
        return;
    }
    
    // Add player to local team
    window.localTeam.push(player);
    updateSquadBadges();
    updateSquadDisplay();
    console.log(`‚úÖ Added ${playerName} to team. Team size: ${window.localTeam.length}`);
    // alert(`‚úÖ Added ${playerName} to your team!`);
    showStatusMessage(`Added ${playerName} to your team.`, 'success');
}

// Dynamic search functionality
function handleSearch() {
    const searchInput = document.getElementById('player-search');
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    console.log('üîç Searching for:', searchTerm);
    
    // Show/hide search dropdown
    if (searchTerm.length >= 2) {
        showSearchDropdown(searchTerm);
    } else {
        hideDropdown();
    }
    
    // Filter players based on search term
    filterPlayers(searchTerm);
}

// Show search dropdown with real player data
function showSearchDropdown(searchTerm) {
    const dropdown = document.getElementById('player-search-dropdown');
    if (!dropdown || dynamicAllPlayers.length === 0) return;

    const matches = dynamicAllPlayers.filter(player => 
        (player.name && player.name.toLowerCase().includes(searchTerm)) ||
        (player.team && player.team.toLowerCase().includes(searchTerm))
    ).slice(0, 10); // Limit to top 10 matches
    
    if (matches.length === 0) {
        dropdown.innerHTML = '<div class="p-3 text-muted">No players found</div>';
    } else {
        dropdown.innerHTML = matches.map(player => {
            const name = player.name || 'Unknown';
            const team = player.team || 'Unknown Team';
            const cost = player.cost ? `¬£${player.cost}m` : '¬£0.0m';
            const elo = player.elo_rating ? Math.round(player.elo_rating * 10) / 10 : 0;
            
            return `
                <div class="p-3 border-bottom" style="cursor: pointer;" 
                     onclick="selectPlayer('${name}')">
                    <div class="fw-bold">${name}</div>
                    <small class="text-muted">${team} ‚Ä¢ ${cost} ‚Ä¢ ${elo}</small>
                </div>
            `;
        }).join('');
    }
    
    dropdown.style.display = 'block';
}

// Filter players based on search term
function filterPlayers(searchTerm = '', positionFilter = 'all') {
    if (dynamicAllPlayers.length === 0) return;

    // Apply search filter
    let filtered = dynamicAllPlayers;
    
    if (searchTerm) {
        filtered = filtered.filter(player => 
            (player.name && player.name.toLowerCase().includes(searchTerm)) || 
            (player.team && player.team.toLowerCase().includes(searchTerm))
        );
    }
    
    // Apply position filter
    if (positionFilter !== 'all') {
        filtered = filtered.filter(player => {
            const playerPos = player.position || '';
            return playerPos === positionFilter;
        });
    }
    
    dynamicFilteredPlayers = filtered;
    renderPlayers();
    updatePlayerCounter(searchTerm, positionFilter);
}

// Hide dropdown
function hideDropdown() {
    const dropdown = document.getElementById('player-search-dropdown');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

// Select player from dropdown
function selectPlayer(playerName) {
    document.getElementById('player-search').value = playerName;
    hideDropdown();
    filterPlayers(playerName.toLowerCase());
}

// Update player counter
function updatePlayerCounter(searchTerm = '', positionFilter = 'all') {
    const counter = document.getElementById('player-counter');
    if (!counter) return;
    
    const totalPlayers = dynamicAllPlayers.length;
    const visiblePlayers = dynamicFilteredPlayers.length;
    
    if (searchTerm && positionFilter !== 'all') {
        counter.textContent = `${visiblePlayers} of ${totalPlayers} ${positionFilter} shown`;
    } else if (searchTerm) {
        counter.textContent = `${visiblePlayers} of ${totalPlayers} players shown`;
    } else if (positionFilter !== 'all') {
        counter.textContent = `${visiblePlayers} ${positionFilter} shown`;
    } else {
        counter.textContent = `${totalPlayers} players shown`;
    }
}

// Filter by position (updated for dynamic data)
function filterByPosition(position) {
    console.log('üéØ Position filter:', position);
    
    const searchTerm = document.getElementById('player-search').value.toLowerCase().trim();
    filterPlayers(searchTerm, position);
}

// Position filter functionality
function setupPositionTabs() {
    const tabs = document.querySelectorAll('.position-tab');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active from all tabs
            tabs.forEach(t => t.classList.remove('active'));
            // Add active to clicked tab
            this.classList.add('active');
            
            const position = this.dataset.position;
            console.log('üéØ Position filter:', position);
            
            filterByPosition(position);
        });
    });
}

// Reset filters (updated for dynamic data)
function resetFilters() {
    console.log('üîÑ Resetting filters...');
    
    // Clear search
    document.getElementById('player-search').value = '';
    hideDropdown();
    
    // Reset position tabs
    document.querySelectorAll('.position-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector('.position-tab[data-position="all"]').classList.add('active');
    
    // Reset to all players
    dynamicFilteredPlayers = [...dynamicAllPlayers];
    renderPlayers();
    updatePlayerCounter();
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM loaded, setting up dynamic player search...');
    
    // Ensure allPlayers is populated for addPlayer function
    if (typeof window.serverPlayers !== 'undefined' && Array.isArray(window.serverPlayers)) {
        dynamicAllPlayers = window.serverPlayers;
        window.dynamicAllPlayers = dynamicAllPlayers;
        console.log(`‚úÖ Global dynamicAllPlayers populated with ${dynamicAllPlayers.length} players`);
    }
    
    
    // Initialize with server data instead of API call
    initializeWithServerData();
    
    // Setup search input
    const searchInput = document.getElementById('player-search');
    if (searchInput) {
        searchInput.addEventListener('input', handleSearch);
        searchInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                handleSearch();
            }
        });
        console.log('‚úÖ Search input setup complete');
    }
    
    // Setup position tabs
    setupPositionTabs();
    console.log('‚úÖ Position tabs setup complete');
    
    // Setup reset button
    const resetBtn = document.getElementById('reset-filters-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', resetFilters);
        console.log('‚úÖ Reset button setup complete');
    }
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.player-search-section')) {
            hideDropdown();
        }
    });
    
    console.log('üéâ Dynamic player search functionality ready!');
});

// Global functions for testing
window.dynamicSearch = {
    filterByPosition,
    resetFilters,
    initializeWithServerData,
    dynamicAllPlayers,
    dynamicFilteredPlayers,
    serverPlayers: window.serverPlayers
};

console.log('‚úÖ Server-based player search script loaded!');

// Filter and render function (corrected version)
function filterAndRender() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;

    playerCards.forEach(card => {
        const name = card.dataset.name || '';
        const team = card.dataset.team || '';
        const playerPosition = card.getAttribute('data-position') || ''; // More direct attribute access

        const matchesSearch = searchTerm === '' || name.includes(searchTerm) || team.includes(searchTerm);
        const matchesPosition = currentPositionFilter === 'all' || playerPosition === currentPositionFilter;

        if (matchesSearch && matchesPosition) {
            card.style.display = 'flex';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    playerCounter.textContent = `${visibleCount} of {{ total_players }} players shown`;
}
</script>

{% endblock %}